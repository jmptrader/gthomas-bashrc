#!/bin/sh
BASE=${BASE:-/var/backups/gibkp}

for dn in "$@"; do
  DEST=${BASE}$dn
  DN=$(dirname $DEST)
  BN=$(basename $DEST)
  echo DEST=$DEST DN=$DN BN=$BN
  if [ ! -x $DEST ]; then
    mkdir -p $DN && git init $DEST || exit $?
    cd $DEST || exit $?
    echo '.git' >> .gitignore
  else
    cd $DEST || exit $?
    if git branch | grep -q master; then
      git checkout -f master || exit $?
    fi
  fi
  cd $DEST || exit $?
  rsync -a --exclude=.git --exclude=.gitignore $dn/ ./ || exit $?
  git add $(ls -d * .[!.] | grep -v .gitignore)
  git commit -am "$(date '+%Y-%m-%dT%H:%M:%S')"
done
