#!/bin/sh
dn=/run/user/$(id -u)
mkdir -p $dn

if [ -x /usr/bin/gpg-connect-agent ]; then
	fn=$dn/.gpg-agent-info
	if [ -e $fn ]; then
		gpg-connect-agent /bye || rm $fn
	fi
	if [ ! -e $fn ] && ! gpg-connect-agent /bye; then
		gpg-agent --daemon --use-standard-socket --write-env-file=$fn
	fi
	if [ -e $fn ]; then
		sed -ne '/^GPG/ s/^/export /p' $fn
	fi
fi

ifn=$dn/E.ssh-agent
sfn=$dn/S.ssh-agent
if [ -e $ifn ]; then
	. $ifn
	ssh-add -l >/dev/null
	if [ $? -eq 2 ]; then
		rm -f $ifn $sfn
	fi
fi
if [ ! -e $ifn ]; then
	killall -9 ssh-agent
	rm -f $sfn
	ssh-agent -t 86400 -a $sfn | grep '^SSH_' > $ifn
fi
cat $ifn
