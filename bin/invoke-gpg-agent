#!/bin/sh
#set -x
dn=/run/user/$(id -u)
mkdir -p $dn

ifn=$dn/E.ssh-agent
#sfn=$dn/S.ssh-agent

if [ -x /usr/bin/gpg-connect-agent ]; then
	fn=$dn/.gpg-agent-info
	if [ -e $fn ]; then
		gpg-connect-agent --no-autostart /bye || rm $fn
	fi
	if [ ! -s $fn ] || ! gpg-connect-agent --no-autostart /bye; then
		gpg-agent --daemon \
			--pinentry-program /usr/bin/pinentry \
			--enable-ssh-support \
			2>&1 | fgrep -v already >&2
			#--extra-socket $dn/S.gpg-agent \
	fi
fi

if [ -s $ifn ]; then
	. $ifn
	rc=0
	ssh-add -l >/dev/null || rc=$?
	if [ $rc -eq 2 ]; then
		rm -f $ifn $sfn
	fi
fi
if [ ! -s $ifn ]; then
	killall -9 ssh-agent
	rm -f $sfn
	. $ifn
	ssh-agent -t 86400 -a $SSH_AUTH_SOCK | grep '^SSH_' > $ifn
fi
. $ifn
cat $ifn
