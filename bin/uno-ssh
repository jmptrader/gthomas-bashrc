#!/bin/sh
export SSH_AUTH_SOCK=/tmp/$USER-ssh-agent.sock

find_pid () {
    [ -n "$SSH_AGENT_PID" ] && [ ! ssh-add -l >/dev/null ] && {
        SSH_AGENT_PID=; export SSH_AGENT_PID
    }
    [ -z "$SSH_AGENT_PID" ] && {
        SSH_AGENT_PID=$(ps -C ssh-agent \
            --ppid $(echo ${SSH_AUTH_SOCK} \
            | cut -d. -f2) -o pid=,cmd | grep ssh-agent | cut -d/ -f1)
        export SSH_AGENT_PID
    }
}
echo 1 SSH_AGENT_PID=$SSH_AGENT_PID SSH_AUTH_SOCK=$SSH_AUTH_SOCK
ssh-add
ssh-add -l | grep -q 'd5:dd:2a:1a:07:3c:75:fd:c8:d8:d6:4b:ed:a3:0d:3b' && exit 0
ssh-agent -k
killall ssh-agent
SSH_AGENT_PID=; export SSH_AGENT_PID
eval $(ssh-agent -a $SSH_AUTH_SOCK -t 7200)
export SSH_AGENT_PID
echo 2 SSH_AGENT_PID=$SSH_AGENT_PID SSH_AUTH_SOCK=$SSH_AUTH_SOCK
ssh-add
ssh-add $HOME/.ssh/tgulacsi@unosoft
