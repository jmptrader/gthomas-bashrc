#!/bin/sh
if [ -z $direct ]; then
    direct=0
	if ip route | fgrep -q 10.65.25; then
		direct=1
	fi
fi

SIZE=${SIZE:-$(getscreensize 2 32)}
echo SIZE=$SIZE
use_sign=$(xfreerdp -h 2>/dev/null 1>/dev/null)
if $use_sign; then
	OPTS="$OPTS -k 0x409 -g $SIZE --ignore-certificate"
	SEC=${SEC:---sec tls}
	destP=
	userP='-u '
	domainP='-d '
else
	OPTS="$OPTS +clipboard /kbd:0x409 -wallpaper -themes \
		/fonts /gdi:sw /drive:tmp,/tmp /size:$SIZE /cert-ignore \
		+async-channels +async-transport +auto-reconnect +heartbeat +multitransport"
	SEC=${SEC:-/sec:tls}
	destP=/v:
	userP=/u:
	domainP=/d:
	if lsusb | grep -q Gemplus; then
		OPTS="$OPTS /a:smartcard,Gemplus"
	fi
fi

dest=${1:-unots2}
prog=${RDP:-xfreerdp}

pkill -f "${prog}.*0x409 .* ${dest_prefix}${dest}"

echo "direct=$direct"
set -x
if [ $direct -gt 0 ]; then
	exec ${prog} ${userP}TGulacsi ${domainP}unosoft ${SEC} $OPTS ${destP}${dest}
else
	CMD="${prog} $OPTS \
		/v:${dest} \
		/u:tgulacsi /d:unosoft \
		/g:mail.unosoft.hu /gu:tgulacsi /gd:unosoft \
		/gp:$(cat ~/.ssh/rdpgw.pwd) \
		$SEC"
    #exec $(dirname $0)/uno "${1:-unots}"; break
    echo $CMD
    exec $CMD
fi
#ssh -o ControlPersist=no -L 3389:unots:3389 -o Port=2222 portforward@mail.unosoft.hu -N
