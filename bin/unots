#!/bin/sh
if [ -z $direct ]; then
    direct=0
	if ip route | fgrep -q 10.65.25; then
		direct=1
	fi
fi

SIZE=${SIZE:-$(getscreensize 2 32)}
echo SIZE=$SIZE
OPTS="$OPTS +clipboard /kbd:0x409 -wallpaper -themes \
	/bpp:15 /decorations /network:lan /fonts \
	/codec-cache:nsc /nsc \
	/smart-sizing /compression /cert-ignore \
	/async-channels /async-transport /async-update /async-input \
	/gdi:hw /drive:tmp,/tmp /size:$SIZE /cert-ignore"
SEC=${SEC:-/sec:nla}
if lsusb | grep -q Gemplus; then
	OPTS="$OPTS /a:smartcard,Gemplus"
fi

dest=${1:-unots2}
prog=${RDP:-xfreerdp}

destIP=$(ping -c1 -n "$dest" | grep '^PING' | head -n1 | cut -d\( -f2 | cut -d\) -f1)
if [ "$destIP" = '10.65.25.3' ]; then
	if ! ip route | fgrep -q "$destIP"; then
		def=$(ip route | grep '^default via ' | head -n1 | cut -d\  -f2-5)
		if echo "$def" | fgrep 192.168.2.; then
			sudo -A ip route add "$destIP" $def
		fi
	fi
fi

port=2503
if [ "$dest" = unots2 ]; then
	port=2504
fi

pkill -f "${prog}.*0x409 .* ${dest_prefix}${dest}"

echo "direct=$direct"
set -x
if [ $direct -gt 0 ]; then
	exec ${prog} /u:TGulacsi /d:unosoft ${SEC} $OPTS /v:${dest}
else
	CMD="${prog} $OPTS \
		/v:outside.unosoft.hu:$port \
		/u:tgulacsi /d:unosoft \
		$SEC"
    #exec $(dirname $0)/uno "${1:-unots}"; break
    echo $CMD
    exec $CMD
fi
#ssh -o ControlPersist=no -L 3389:unots:3389 -o Port=2222 portforward@mail.unosoft.hu -N
