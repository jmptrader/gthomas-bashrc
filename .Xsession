#!/bin/sh
export OOO_FORCE_DESKTOP=gnome
if ! echo "$PATH" | grep -q "$USER"; then
    export PATH="$HOME/bin:$PATH"
fi
HOST=$(hostname)
for nm in awesome scrotwm; do
  if which $nm >/dev/null; then
    DEFAULT_WM=$nm
    break
  fi
done
xrandr -s $(xrandr --prop|grep x|grep '^ '|head -n 1|awk '{print $1}')
#xsetroot -solid black -cursor_name top_left_arrow
for fn in ~/.Xdefaults*; do
  [ -e "$fn" ] && xrdb -merge "$fn"
done
[ -x ~/bin/xkbmap ] && ~/bin/xkbmap

run_daemon () {
    if which "$1" 2>/dev/null; then
        pidof "$1" && killall "$1" && sleep 3
        echo "starting daemon $@..."
        (exec "$@") &
    fi
}

# xfce4-panel &

if [ "$HOST" = hackworth ]; then
  run_daemon wicd-gtk
else
  run_daemon nm-applet --sm-disable
fi
if [ "$HOST" != tgulacsi-desktop ]; then
  if [ -x /usr/bin/xfce4-power-manager ]; then
    run_daemon xfce4-power-manager
  else
    run_daemon gnome-power-manager
  fi
fi
which gnome-keyring-daemon >/dev/null \
  && eval $(gnome-keyring-daemon -c pkcs11,secrets,ssh -sd)

run_daemon gajim

# run_daemon nm-applet
# run_daemon gnome-settings-daemon
# run_daemon gnome-power-manager
# run_daemon update-notifier
# run_daemon Thunar --daemon

# pgrep checkgmail && killall checkgmail && sleep 3; (sleep 10; checkgmail) &

# run_daemon klipper

# run_daemon remind -z '-knotify-send -t 5000 Remind %s' ~/.rem

if [ -z "$MY_WM" ]; then
    MY_WM=$DEFAULT_WM
fi

case "$MY_WM" in
xmonad)
    # /home/ian/bin/trayer.sh &
    CMD=xmonad
;;
openbox)
    CMD=gnome-session
;;
xfce4)
    CMD=startxfce4
;;
qtile)
    CMD="ck-launch-session qtile -f default"
;;
scrotwm)
    CMD="ck-launch-session $MY_WM"
;;
$DEFAULT_WM)
    #exec ck-launch-session xterm
    CMD="ck-launch-session $MY_WM"
;;
*)
    CMD="ck-launch-session xterm -e '$MY_WM'"
;;
esac
#CMD=x-terminal-emulator
logger ".xinitrc CMD=$CMD"
echo CMD="$CMD"
exec $CMD 2>&1 | logger -t xinit -i
#exec x-terminal-emulator
